// 收集所有子项目中的 @KoinModule 注解信息的 Gradle 脚本

task collectKoinModules {
    group = "koin"
    description = "收集所有子项目中的 @KoinModule 注解信息"
    
    doLast {
        def koinModules = []
        
        // 遍历所有子项目
        subprojects.each { subproject ->
            def srcDirs = [
                new File(subproject.projectDir, "src/main/java"),
                new File(subproject.projectDir, "src/main/kotlin")
            ]
            
            srcDirs.each { srcDir ->
                if (srcDir.exists()) {
                    srcDir.eachFileRecurse { file ->
                        if (file.name.endsWith('.kt') || file.name.endsWith('.java')) {
                            def content = file.text
                            if (content.contains('@KoinModule')) {
                                // 解析包名
                                def packageMatch = content =~ /package\s+([\w.]+)/
                                if (packageMatch) {
                                    def packageName = packageMatch[0][1]
                                    
                                    // 查找所有被 @KoinModule 注解的函数
                                    def functionMatches = content =~ /@KoinModule\s*\n\s*fun\s+(\w+)/
                                    functionMatches.each { match ->
                                        def functionName = match[1]
                                        koinModules.add("${packageName}:${functionName}")
                                        println "发现 @KoinModule: ${packageName}.${functionName}"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        
        // 生成模块信息文件
        def outputDir = new File(project.buildDir, "generated/koin")
        outputDir.mkdirs()
        def outputFile = new File(outputDir, "koin-modules.txt")
        
        outputFile.text = koinModules.join('\n')
        println "生成了 ${koinModules.size()} 个 Koin 模块信息到: ${outputFile.absolutePath}"
    }
}